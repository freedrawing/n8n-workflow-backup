{
  "active": false,
  "connections": {
    "Check duplication": {
      "main": [
        [
          {
            "index": 0,
            "node": "Message Payload Builder",
            "type": "main"
          },
          {
            "index": 0,
            "node": "New sortedSet filter",
            "type": "main"
          }
        ]
      ]
    },
    "Get author": {
      "main": [
        [
          {
            "index": 0,
            "node": "Get stored articles",
            "type": "main"
          }
        ]
      ]
    },
    "Get stored articles": {
      "main": [
        [
          {
            "index": 0,
            "node": "Merge",
            "type": "main"
          }
        ]
      ]
    },
    "Loop Over Items1": {
      "main": [
        [],
        [
          {
            "index": 0,
            "node": "메시지 전송",
            "type": "main"
          }
        ]
      ]
    },
    "Loop Over Items2": {
      "main": [
        [],
        [
          {
            "index": 0,
            "node": "Update new SortedSet",
            "type": "main"
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "index": 0,
            "node": "Check duplication",
            "type": "main"
          }
        ]
      ]
    },
    "Message Payload Builder": {
      "main": [
        [
          {
            "index": 0,
            "node": "Loop Over Items1",
            "type": "main"
          }
        ]
      ]
    },
    "New sortedSet filter": {
      "main": [
        [
          {
            "index": 0,
            "node": "Loop Over Items2",
            "type": "main"
          }
        ]
      ]
    },
    "RSS Read": {
      "main": [
        [
          {
            "index": 0,
            "node": "Get author",
            "type": "main"
          },
          {
            "index": 0,
            "node": "Slicing latest 10 items",
            "type": "main"
          }
        ]
      ]
    },
    "Slicing latest 10 items": {
      "main": [
        [
          {
            "index": 1,
            "node": "Merge",
            "type": "main"
          }
        ]
      ]
    },
    "Update new SortedSet": {
      "main": [
        [
          {
            "index": 0,
            "node": "Loop Over Items2",
            "type": "main"
          }
        ]
      ]
    },
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "index": 0,
            "node": "RSS Read",
            "type": "main"
          }
        ]
      ]
    },
    "메시지 전송": {
      "main": [
        [
          {
            "index": 0,
            "node": "Loop Over Items1",
            "type": "main"
          }
        ]
      ]
    }
  },
  "id": "P2rm5erg2xNyCmhT",
  "isArchived": false,
  "name": "RSS watcher module",
  "nodes": [
    {
      "alwaysOutputData": true,
      "id": "fcb0046f-1d02-4c54-9cc1-f077e17c05f8",
      "name": "RSS Read",
      "parameters": {
        "options": {
          "ignoreSSL": false
        },
        "url": "={{ $json.rssUrl ?? \"https://dnr2144.tistory.com/rss\" }}\n"
      },
      "position": [
        -1056,
        -368
      ],
      "type": "n8n-nodes-base.rssFeedRead",
      "typeVersion": 1.2
    },
    {
      "id": "053f1d63-f011-439b-bc6c-4ee8a7d738ad",
      "name": "Get author",
      "parameters": {
        "jsCode": "const author = $input.first().json.author || $input.first().json.creator;\n\nreturn [\n  {\n    json: {\n      author: author\n    }\n  }\n];"
      },
      "position": [
        -848,
        -496
      ],
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "id": "2fec90fc-9bbf-48e1-9c95-529651fcbe4f",
      "name": "Slicing latest 10 items",
      "parameters": {
        "jsCode": "return [\n  {\n    json: {\n      latestArticles: items.slice(0, 10)\n    }\n  }\n];\n\n// return items.slice(0, 10);"
      },
      "position": [
        -768,
        -304
      ],
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "id": "bf9073a9-f31b-4e74-84c9-905ac70542aa",
      "name": "Check duplication",
      "parameters": {
        "jsCode": "const all = $input.all();\nconst stored = all[0].json.result;  // Redis ZSET 값\nconst latest = all[1].json.latestArticles;           // RSS 10개\n\n// Set으로 빠르게 검색\nconst storedSet = new Set(stored);\n\nconst newPosts = latest.filter(article => storedSet.has(article.json.guid) == false);\n\n// 새로운 글 + 최신 글 다음 노드로 전달\nreturn [\n  {\n    json: {\n      newPosts,\n      latest\n    }\n  }\n];\n\n"
      },
      "position": [
        -288,
        -368
      ],
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "id": "6cb70542-574d-452b-b68d-ab8ed40fd826",
      "name": "Merge",
      "parameters": {},
      "position": [
        -464,
        -368
      ],
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2
    },
    {
      "id": "97ce373b-d1e5-4f2c-94a7-a431ca377e6e",
      "name": "Loop Over Items1",
      "parameters": {
        "options": {}
      },
      "position": [
        224,
        -288
      ],
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3
    },
    {
      "credentials": {
        "telegramApi": {
          "id": "ejLmvh6eni9woYLp",
          "name": "Telegram account"
        }
      },
      "id": "accd4056-8506-459c-8f2e-04353338a20c",
      "name": "메시지 전송",
      "parameters": {
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        },
        "chatId": "-4891878660",
        "text": "=<strong>🆕🆕🆕  새 글이 올라왔어요! 🆕🆕🆕</strong>\n<a href=\"{{$json.safeLink}}\"> {{ $json.safeTitle }} by {{$json.author}}</a>\n\n({{ $json.pubDate }})"
      },
      "position": [
        512,
        -256
      ],
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "webhookId": "99af6d42-48fd-4438-88dd-9797e7a3c0b2"
    },
    {
      "credentials": {
        "redis": {
          "id": "wUQMer6jnoB9wK9u",
          "name": "Redis account"
        }
      },
      "id": "ea38a9e2-121b-42e3-a0d0-affd9a093525",
      "name": "Update new SortedSet",
      "parameters": {
        "operation": "zadd",
        "scoreMembers": "={{ $json.score }} {{ $json.value }}",
        "sortedSet": "={{$json[\"key\"].replace(/\\s+/g, \"_\")}}"
      },
      "position": [
        528,
        -640
      ],
      "type": "@vicenterusso/n8n-nodes-redis-enhanced.redisEnhanced",
      "typeVersion": 1
    },
    {
      "id": "d7228d47-c58f-46db-b856-c147d2b19782",
      "name": "New sortedSet filter",
      "parameters": {
        "jsCode": "const { latest } = items[0].json;\n\nreturn latest.map((article, index) => {\n  // console.log(article);\n  // pubDate를 timestamp로 변환 (밀리초 단위)\n  const score = new Date(article.json.pubDate).getTime() / 1000; // 초 단위\n  \n  return {\n    json: {\n      key: `rss:blog:${article.json.author}`,\n      score: score,\n      value: article.json.guid  // guid 또는 link\n    }\n  };\n});\n"
      },
      "position": [
        -64,
        -448
      ],
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "id": "edf4a5c6-9bae-46c8-b703-105c1accd227",
      "name": "Loop Over Items2",
      "parameters": {
        "options": {}
      },
      "position": [
        304,
        -656
      ],
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3
    },
    {
      "id": "024e63aa-bbfb-48a4-8d8a-750d8cbcc267",
      "name": "Message Payload Builder",
      "parameters": {
        "jsCode": "const { newPosts } = items[0].json;\n\n// newPosts만 남기기\nreturn newPosts.map(item => {\n  const data = item.json;\n  const safeLink = data.link.replace(/&/g, '&amp;');\n  const safeTitle = data.title.replace(/&/g, '&amp;');\n\n  return {\n    json: {\n      ...data,\n      safeLink,\n      safeTitle\n    }\n  };\n});\n"
      },
      "position": [
        -64,
        -256
      ],
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "id": "87ea3454-f842-4b65-894d-8fa9ddab1492",
      "name": "When Executed by Another Workflow",
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "rssUrl"
            }
          ]
        }
      },
      "position": [
        -1216,
        -368
      ],
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1
    },
    {
      "id": "b0e98606-c814-4ded-93db-5589149c8fee",
      "name": "Sticky Note",
      "parameters": {
        "color": 3,
        "content": "## Rss watcher sub Workflow",
        "height": 660,
        "width": 1920
      },
      "position": [
        -1248,
        -688
      ],
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1
    },
    {
      "credentials": {
        "redis": {
          "id": "wUQMer6jnoB9wK9u",
          "name": "Redis account"
        }
      },
      "id": "96582172-b3ac-4f3a-b34c-99ed5bc536af",
      "name": "Get stored articles",
      "parameters": {
        "args": "0 -1",
        "keys": "=rss:blog:{{$json[\"author\"].replace(/\\s+/g, \"_\")}}",
        "operation": "eval",
        "script": "-- KEYS[1] = sorted set key\n-- ARGV[1] = start index\n-- ARGV[2] = stop index\n-- return redis.call('ZREVRANGE', KEYS[1], ARGV[1], ARGV[2], 'WITHSCORES')\nreturn redis.call('ZREVRANGE', KEYS[1], ARGV[1], ARGV[2])"
      },
      "position": [
        -640,
        -496
      ],
      "type": "@vicenterusso/n8n-nodes-redis-enhanced.redisEnhanced",
      "typeVersion": 1
    }
  ],
  "repo_name": "n8n-workflow-backup",
  "repo_owner": "freedrawing",
  "repo_path": "https://github.com/freedrawing/n8n-workflow-backup.git",
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [],
  "triggerCount": 0
}